<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configura√ß√µes - Admin</title>
  <link rel="stylesheet" href="assets/css/admin.css">
</head>
<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>üì¶ Admin</h2>
      </div>
      <nav class="sidebar-nav">
        <a href="index.html" class="nav-item">
          <span class="icon">üìä</span>
          <span>Dashboard</span>
        </a>
        <a href="produtos.html" class="nav-item">
          <span class="icon">üì¶</span>
          <span>Produtos</span>
        </a>
        <a href="metricas.html" class="nav-item">
          <span class="icon">üìà</span>
          <span>M√©tricas</span>
        </a>
        <a href="configuracoes.html" class="nav-item active">
          <span class="icon">‚öôÔ∏è</span>
          <span>Configura√ß√µes</span>
        </a>
        <a href="../catalogo/index.html" class="nav-item" target="_blank">
          <span class="icon">üåê</span>
          <span>Ver Cat√°logo</span>
        </a>
      </nav>
      <div class="sidebar-footer">
        <button id="logoutBtn" class="btn-logout">Sair</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="topbar">
        <h1>Configura√ß√µes</h1>
      </header>

      <div class="container">
        <form id="configForm" class="form-card">
          <h2>Informa√ß√µes da Loja</h2>

          <!-- Nome da Loja -->
          <div class="form-group">
            <label for="nomeLoja">Nome da Loja *</label>
            <input type="text" id="nomeLoja" name="nomeLoja" required placeholder="Minha Loja">
          </div>

          <!-- WhatsApp -->
          <div class="form-group">
            <label for="whatsapp">N√∫mero do WhatsApp *</label>
            <input type="text" id="whatsapp" name="whatsapp" required 
                   placeholder="5511999999999" 
                   pattern="[0-9]{10,15}">
            <small>Formato: c√≥digo do pa√≠s + DDD + n√∫mero (apenas n√∫meros)</small>
          </div>

          <!-- Mensagem Padr√£o -->
          <div class="form-group">
            <label for="mensagemPadrao">Mensagem Padr√£o do WhatsApp</label>
            <textarea id="mensagemPadrao" name="mensagemPadrao" rows="6" 
                      placeholder="Ol√°! Gostaria de fazer um pedido:"></textarea>
            <small>
              <strong>Vari√°veis dispon√≠veis:</strong><br>
              {produto} - Nome do produto<br>
              {marca} - Marca do produto<br>
              {tamanho} - Tamanho selecionado<br>
              {pagamento} - Forma de pagamento (PIX ou Cart√£o)<br>
              {valor} - Valor do produto
            </small>
          </div>

          <h2>Configura√ß√µes de Pre√ßo</h2>

          <!-- Taxa Motoboy -->
          <div class="form-group">
            <label for="taxaMotoboy">Taxa de Entrega (Motoboy) - R$</label>
            <input type="number" id="taxaMotoboy" name="taxaMotoboy" step="0.01" min="0" 
                   placeholder="8.00">
            <small>Valor ser√° exibido no cat√°logo p√∫blico</small>
          </div>

          <!-- Parcelas Sem Juros -->
          <div class="form-group">
            <label for="parcelasSemJuros">Parcelas Sem Juros (Cart√£o)</label>
            <input type="number" id="parcelasSemJuros" name="parcelasSemJuros" min="1" max="12" 
                   placeholder="3">
            <small>N√∫mero de parcelas sem juros no cart√£o</small>
          </div>

          <h2>Tracking e Analytics</h2>

          <!-- Pixel Facebook -->
          <div class="form-group">
            <label for="pixelFacebook">Pixel do Facebook (ID)</label>
            <input type="text" id="pixelFacebook" name="pixelFacebook" 
                   placeholder="123456789012345">
            <small>Cole apenas o ID do Pixel (n√∫meros)</small>
          </div>

          <!-- GTM Google -->
          <div class="form-group">
            <label for="gtmGoogle">Google Tag Manager (GTM-ID)</label>
            <input type="text" id="gtmGoogle" name="gtmGoogle" 
                   placeholder="GTM-XXXXXXX">
            <small>Cole o ID do container GTM (ex: GTM-ABC1234)</small>
          </div>

          <h2>Menu de Categorias</h2>

          <!-- Categorias do Menu -->
          <div class="form-group">
            <label for="menuCategorias">Categorias do Menu (uma por linha)</label>
            <textarea id="menuCategorias" name="menuCategorias" rows="5" 
                      placeholder="Camisetas&#10;Cal√ßas&#10;Shorts&#10;Acess√≥rios"></textarea>
            <small>Digite uma categoria por linha. Elas aparecer√£o como filtros no cat√°logo.</small>
          </div>

          <!-- Bot√µes -->
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Salvar Configura√ß√µes</button>
          </div>
        </form>

        <!-- Informa√ß√µes -->
        <div class="info-box">
          <h3>‚ÑπÔ∏è Sobre as Configura√ß√µes</h3>
          <ul>
            <li><strong>Nome da Loja:</strong> Ser√° exibido no cat√°logo p√∫blico</li>
            <li><strong>WhatsApp:</strong> N√∫mero para onde ser√£o enviados os pedidos</li>
            <li><strong>Mensagem Padr√£o:</strong> Texto inicial da mensagem de pedido</li>
          </ul>
        </div>
      </div>
    </main>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <!-- Scripts -->
  <script src="assets/js/firebase.js"></script>
  <script src="assets/js/auth.service.js"></script>
  <script src="assets/js/auth.guard.js"></script>
  <script src="assets/js/config.service.js"></script>
  <script src="assets/js/produtos.ui.js"></script>

  <script>
    // Carregar configura√ß√µes
    async function carregarConfiguracoes() {
      const config = await ConfigService.buscar();
      
      document.getElementById('nomeLoja').value = config.nomeLoja;
      document.getElementById('whatsapp').value = config.whatsapp;
      document.getElementById('mensagemPadrao').value = config.mensagemPadrao;
      document.getElementById('taxaMotoboy').value = config.taxaMotoboy || 8.00;
      document.getElementById('parcelasSemJuros').value = config.parcelasSemJuros || 3;
      document.getElementById('pixelFacebook').value = config.pixelFacebook || '';
      document.getElementById('gtmGoogle').value = config.gtmGoogle || '';
      
      // Carregar categorias do menu
      if (config.menuCategorias && Array.isArray(config.menuCategorias)) {
        document.getElementById('menuCategorias').value = config.menuCategorias.join('\n');
      }
    }

    // Salvar configura√ß√µes
    document.getElementById('configForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Processar categorias do menu
      const categoriasText = document.getElementById('menuCategorias').value;
      const menuCategorias = categoriasText
        .split('\n')
        .map(cat => cat.trim())
        .filter(cat => cat.length > 0);

      const config = {
        nomeLoja: document.getElementById('nomeLoja').value.trim(),
        whatsapp: document.getElementById('whatsapp').value.trim(),
        mensagemPadrao: document.getElementById('mensagemPadrao').value.trim(),
        taxaMotoboy: parseFloat(document.getElementById('taxaMotoboy').value) || 0,
        parcelasSemJuros: parseInt(document.getElementById('parcelasSemJuros').value) || 1,
        pixelFacebook: document.getElementById('pixelFacebook').value.trim(),
        gtmGoogle: document.getElementById('gtmGoogle').value.trim(),
        menuCategorias: menuCategorias
      };

      // Validar WhatsApp
      if (!ConfigService.validarWhatsApp(config.whatsapp)) {
        ProdutosUI.mostrarMensagem('N√∫mero de WhatsApp inv√°lido', 'error');
        return;
      }

      ProdutosUI.mostrarLoading('Salvando configura√ß√µes...');
      const result = await ConfigService.salvar(config);
      ProdutosUI.esconderLoading();

      if (result.success) {
        ProdutosUI.mostrarMensagem('Configura√ß√µes salvas com sucesso!', 'success');
      } else {
        ProdutosUI.mostrarMensagem('Erro ao salvar configura√ß√µes', 'error');
      }
    });

    // Executar ao carregar
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', carregarConfiguracoes);
    } else {
      carregarConfiguracoes();
    }
  </script>
</body>
</html>